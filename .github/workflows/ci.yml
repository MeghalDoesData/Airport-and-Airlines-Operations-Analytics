name: CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BUCKET: airport-airline-operations-analytics-platform

      GLUE_SCRIPT: glue_job.py
      GLUE_SCRIPT_KEY: scripts/glue_job.py

      LAMBDA_FILE: lambda.py
      LAMBDA_KEY: lambda/lambda.zip

      GLUE_STACK: glue-job-stack
      CRAWLER_STACK: crawler-stack
      LAMBDA_STACK: lambda-stack

      GLUE_JOB: FinalGlue
      LAMBDA_NAME: raw-upload-trigger

    steps:

# ======================
# Checkout
# ======================
    - uses: actions/checkout@v4

# ======================
# Debug
# ======================
    - name: Show repo files
      run: ls -R

# ======================
# Python
# ======================
    - uses: actions/setup-python@v5
      with:
        python-version: "3.9"

# ======================
# AWS Login
# ======================
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

# ======================
# Upload Glue Script
# ======================
    - name: Upload Glue Script
      run: |
        test -f $GLUE_SCRIPT || exit 1
        aws s3 cp $GLUE_SCRIPT s3://$BUCKET/$GLUE_SCRIPT_KEY

# ======================
# Package Lambda
# ======================
    - name: Package Lambda
      run: |
        test -f $LAMBDA_FILE || exit 1
        zip lambda.zip $LAMBDA_FILE
        aws s3 cp lambda.zip s3://$BUCKET/$LAMBDA_KEY

# ======================
# Cleanup bad stacks
# ======================
    - name: Cleanup Failed Stacks
      run: |
        for S in $GLUE_STACK $CRAWLER_STACK $LAMBDA_STACK; do
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name $S \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NONE")

          if [[ "$STATUS" == "ROLLBACK_COMPLETE" || "$STATUS" == "UPDATE_ROLLBACK_FAILED" ]]; then
            aws cloudformation delete-stack --stack-name $S
            aws cloudformation wait stack-delete-complete --stack-name $S
          fi
        done

# ======================
# Deploy Lambda
# ======================
    - name: Deploy Lambda Stack
      run: |
        aws cloudformation deploy \
          --stack-name $LAMBDA_STACK \
          --template-file lambda-template.yaml \
          --parameter-overrides \
            CodeBucket=$BUCKET \
            CodeKey=$LAMBDA_KEY \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

# ======================
# Attach S3 trigger
# ======================
    - name: Attach S3 Trigger
      run: |
        ARN=$(aws lambda get-function \
          --function-name $LAMBDA_NAME \
          --query Configuration.FunctionArn \
          --output text)

        aws s3api put-bucket-notification-configuration \
          --bucket $BUCKET \
          --notification-configuration "{
            \"LambdaFunctionConfigurations\": [
              {
                \"LambdaFunctionArn\": \"$ARN\",
                \"Events\": [\"s3:ObjectCreated:*\"],
                \"Filter\": {\"Key\": {\"FilterRules\": [{\"Name\":\"prefix\",\"Value\":\"raw/\"}]}}
              }
            ]
          }"

# ======================
# Deploy Glue Job
# ======================
    - name: Deploy Glue Stack
      run: |
        aws cloudformation deploy \
          --stack-name $GLUE_STACK \
          --template-file template.yaml \
          --parameter-overrides \
            ScriptBucket=$BUCKET \
            ScriptKey=$GLUE_SCRIPT_KEY \
            JobName=$GLUE_JOB \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

# ======================
# Deploy Crawlers
# ======================
    - name: Deploy Crawlers
      run: |
        aws cloudformation deploy \
          --stack-name $CRAWLER_STACK \
          --template-file crawler-template.yaml \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

# ======================
# Run Glue Job
# ======================
    - name: Start Glue Job
      run: |
        RID=$(aws glue start-job-run \
          --job-name $GLUE_JOB \
          --query JobRunId \
          --output text)

        echo "RID=$RID" >> $GITHUB_ENV

# ======================
# Wait Glue Success
# ======================
    - name: Wait Glue Success
      run: |
        for i in {1..80}; do
          S=$(aws glue get-job-run \
            --job-name $GLUE_JOB \
            --run-id $RID \
            --query JobRun.JobRunState \
            --output text)

          echo "Glue: $S"

          [[ "$S" == "SUCCEEDED" ]] && exit 0
          [[ "$S" == "FAILED" || "$S" == "STOPPED" ]] && exit 1

          sleep 30
        done
        exit 1

# ======================
# Airline crawler wait
# ======================
    - name: Run Airline Crawler
      run: |
        aws glue start-crawler --name airline || true
        while true; do
          S=$(aws glue get-crawler --name airline --query 'Crawler.State' --output text)
          echo "airline: $S"
          [[ "$S" == "READY" ]] && break
          sleep 20
        done

# ======================
# Customers crawler wait
# ======================
    - name: Run Customers Crawler
      run: |
        aws glue start-crawler --name customers || true
        while true; do
          S=$(aws glue get-crawler --name customers --query 'Crawler.State' --output text)
          echo "customers: $S"
          [[ "$S" == "READY" ]] && break
          sleep 20
        done

# ======================
# Done
# ======================
    - name: Done
      run: echo "Glue + Airline + Customers crawlers SUCCESS"
